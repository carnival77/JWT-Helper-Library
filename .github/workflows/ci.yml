name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# WRITE í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤. (ì¤‘ìš”)
#permissions: write-all

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    # WRITE í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤. (ì¤‘ìš”)
    permissions:
      pull-requests: write
    steps:
      - name: Check out the code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
            
      # gradle wrapperë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ì‹¤í–‰ ê¶Œí•œ (+x)ì„ ì¤ë‹ˆë‹¤.
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # ./gradlew buildë¥¼ í†µí•´ í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•˜ê³  í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•œë‹¤.
      # jacocoTestReport íƒœìŠ¤í¬ë¥¼ í†µí•´ JaCoCo ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•œë‹¤.
      # ì´ ë‹¨ê³„ì—ì„œ ê¸°ë³¸ì ì¸ ë¹Œë“œì™€ í…ŒìŠ¤íŠ¸, ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸(HTML, XML)ê°€ ëª¨ë‘ ì¤€ë¹„ëœë‹¤.
      - name: Build with Gradle and Test with Coverage # ë¹Œë“œ + í…ŒìŠ¤íŠ¸ + ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±.
        run: ./gradlew clean build jacocoTestReport --no-daemon

      # actions/upload-artifact ì•¡ì…˜ì„ í†µí•´ ìƒì„±ëœ ì»¤ë²„ë¦¬ì§€ HTML ë¦¬í¬íŠ¸ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œí•œë‹¤.
      # ë¹Œë“œê°€ ì™„ë£Œë˜ë©´ GitHub Actions ê²°ê³¼ í˜ì´ì§€ì—ì„œ ì´ HTML ì•„í‹°íŒ©íŠ¸ë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ì•„ ë¡œì»¬ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì–´ë³¼ ìˆ˜ ìˆë‹¤.
      - name: Upload coverage report (HTML)
        uses: actions/upload-artifact@v3 # HTML ë¦¬í¬íŠ¸ë¥¼ GitHub Actions ê²°ê³¼ í˜ì´ì§€ì—ì„œ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•˜ë„ë¡ ì—…ë¡œë“œ.
        with:
          name: coverage-html-report
          path: build/reports/jacoco/test/html

      # PR ë¦¬ë·°ì–´ê°€ ë³€ê²½ëœ ì½”ë“œì— ëŒ€í•œ ì»¤ë²„ë¦¬ì§€ ì •ë³´ë¥¼ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
      # ë¹Œë“œ/í…ŒìŠ¤íŠ¸ íŒŒì´í”„ë¼ì¸ ê²°ê³¼ë¡œ ë‹¨ìˆœíˆ ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœë§Œ ë³´ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì»¤ë²„ë¦¬ì§€ í–¥ìƒ ì—¬ë¶€ë‚˜ ë¶€ì¡±í•œ ë¶€ë¶„ì„ PR ëŒ€í™”ì—ì„œ ì§ì ‘ íŒŒì•… ê°€ëŠ¥í•˜ë‹¤.
      - name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ë¥¼ PRì— ì½”ë©˜íŠ¸ë¡œ ë“±ë¡
        id: jacoco
        uses: madrapps/jacoco-report@v1.6.1 # JaCoCo XML ë¦¬í¬íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ PRì— ì»¤ë²„ë¦¬ì§€ ê²°ê³¼ë¥¼ ì½”ë©˜íŠ¸ë¡œ ë‚¨ê¸´ë‹¤.
        with:
          title: ğŸ“ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
          paths: ${{ github.workspace }}/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 60
          min-coverage-changed-files: 60
